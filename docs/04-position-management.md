# 持仓管理与 Merge 操作

> 做市商最容易犯的错误不是报错了价，而是**不知不觉中积累了巨额单边仓位**。
> 理解持仓如何被动累积，以及如何用最低成本调回平衡，是这一章的核心。

---

## 1. 持仓是怎么"被动"产生的

### 1.1 理想世界与现实世界的差距

```
理想情况：
  你以 0.49 买入 YES → 价格涨一点 → 你以 0.51 卖出 YES
  反复循环，双边对称成交，净持仓 = 0

现实：市场趋势导致单边连续成交

  市场持续上涨时：
    你的 ASK（卖 YES）被大量成交 → 你不断收 USDC
    你的 BID（买 YES）没人成交 → 继续挂着
    系统重新挂单（追踪价格），新 BID 又被吃掉
    结果：净持仓 = 大量 USDC + 0 YES（本来应该双边平衡）

  市场持续下跌时：
    你的 BID（买 YES）被大量成交 → 你不断买入 YES
    你的 ASK（卖 YES）没人成交
    结果：净持仓 = 大量 YES + 少量 USDC

→ 你承担了"方向性风险"，但这不是你的本意
```

### 1.2 一个完整的仓位积累过程

```
时间线（初始：$500 USDC，市场价格 0.50）

T=0  挂单：bid@0.49 $100，ask@0.51 $100
     持仓：YES=0，NO=0，USDC=300（$200 在挂单中）

T=1  一个大户持续买入，价格从 0.50 → 0.55
     ask@0.51 全部被吃：你卖出了 100 YES，收到 $51 USDC
     bid@0.49 没人接：还在挂
     你的系统跟随价格更新挂单：
       新 ask@0.56，新 bid@0.54

T=2  大户继续买入，价格 0.55 → 0.62
     bid@0.54 全部被吃：你买入了 100 YES，花了 $54 USDC
     ask@0.56 没人接
     持仓：YES=100，NO=0
     IIR = (100-0)/(100+0) = +1.0（完全单边！）

T=3  你重新挂单：ask@0.62，bid@0.60
     价格继续涨，大户仍在买
     bid@0.60 被吃：你又买了 100 YES
     持仓：YES=200，NO=0

风险所在：
  你持有 200 YES，平均成本约 0.57
  如果消息是假的，价格暴跌回 0.40
  200 YES × (0.57 - 0.40) = $34 浮亏
  这个亏损可能吞掉几天的做市奖励
```

---

## 2. IIR（持仓失衡比率）：量化持仓风险

### 2.1 公式定义

```
IIR = (YES持仓价值 - NO持仓价值) / (YES持仓价值 + NO持仓价值)

注意：这里用的是 USDC 计价的市值，不是代币数量！
  YES持仓价值 = YES代币数量 × 当前中间价
  NO持仓价值  = NO代币数量  × (1 - 当前中间价)

范围：[-1.0, +1.0]
  +1.0 = 完全持有 YES，没有 NO（单边多头）
  -1.0 = 完全持有 NO，没有 YES（单边空头）
   0.0 = 完美对称平衡
```

### 2.2 各阈值的含义和对应操作

```
|IIR|    状态     含义                         响应
────────────────────────────────────────────────────────────
< 0.30   正常     轻微失衡，在可接受范围内      轻微 Quote Skewing（偏移 0.5 cents）
< 0.50   偏高     值得注意，但还可以承受         加强 Skewing + 减少偏向侧规模 50%
< 0.75   危险     仓位风险开始超过奖励收益       主动减仓 + 触发 Merge（如果有对冲单）
≥ 0.75   紧急     极端单边，最大回撤风险         取消所有挂单，评估是否市价减仓
────────────────────────────────────────────────────────────
```

### 2.3 实际计算示例

```
场景：你在某预测市场的持仓情况
  持有 300 YES 代币
  持有 500 NO 代币
  当前中间价 = 0.60

计算：
  YES持仓价值 = 300 × 0.60 = $180
  NO持仓价值  = 500 × (1 - 0.60) = 500 × 0.40 = $200

  IIR = (180 - 200) / (180 + 200) = -20 / 380 = -0.053

解读：
  IIR = -0.053，轻微偏向 NO 侧
  |IIR| < 0.30，属于正常范围
  不需要大动作，轻微 Skewing 即可
```

---

## 3. Quote Skewing（报价偏斜）：优雅的被动调仓

### 3.1 核心思路

```
错误做法：直接在市场上卖出持仓
  问题：
    1. 市价单有滑点（尤其是流动性差的市场）
    2. 大额卖出会冲击价格，损害自己后续挂单的竞争力
    3. 产生明显的 PnL 实现事件，影响账目

正确做法：通过调整挂单价格，让市场自然帮你减仓
  不主动出售，而是把卖价调低、买价调低
  → 卖出概率增大，买入概率减小
  → 市场帮你完成调仓，无需主动干预
```

### 3.2 偏斜计算公式

```
skew_amount = IIR × skew_factor

  IIR = 当前持仓失衡比率（-1 到 +1）
  skew_factor = 调整系数（建议值：0.02，即最大偏移 2 cents）

偏斜后的报价：
  skewed_bid = normal_bid - skew_amount
  skewed_ask = normal_ask - skew_amount

注意：bid 和 ask 同向移动！
  这样维持了相同的价差宽度，只是整体价格中心偏移了
```

### 3.3 完整示例：持有过多 YES（IIR = +0.6）

```
市场状态：
  adjusted_midpoint = 0.60
  基础价差 = 2 cents（各侧 1 cent）

正常报价：
  bid@0.59（中间价 -1 cent）
  ask@0.61（中间价 +1 cent）

偏斜计算：
  skew_amount = IIR × skew_factor = 0.6 × 0.02 = +0.012

偏斜后报价：
  skewed_bid = 0.59 - 0.012 = 0.578 ≈ 0.578
  skewed_ask = 0.61 - 0.012 = 0.598 ≈ 0.598

效果分析：
  bid 从 0.59 降到 0.578：
    → 对手方要卖 YES 给你的意愿降低（价格不吸引人）
    → 你买入更多 YES 的概率降低

  ask 从 0.61 降到 0.598：
    → 对手方买 YES 的价格降低（更便宜，更吸引人）
    → 你卖出 YES 的概率增大

  净效果：持仓自然向 YES=0 方向移动
```

### 3.4 偏斜的边界约束

```
两个硬性限制：

1. 价格不能超出 [0.01, 0.99]（Polymarket 平台限制）
   if skewed_bid < 0.01: skewed_bid = 0.01
   if skewed_ask > 0.99: skewed_ask = 0.99

2. 偏斜量不能让挂单超出 max_spread（否则不得奖励）
   if |skewed_bid - adjusted_midpoint| >= max_spread:
       # 买单偏斜过多，已超出激励范围
       # 减小偏斜量或直接不挂买单

3. 偏斜量上限（建议）：≤ 3 cents
   偏斜太多会让挂单脱离竞争区间，成交率降低
   偏斜太少调仓效果不明显
   → 2 cents 左右是实战中的平衡点
```

---

## 4. Merge 操作：零损耗的终极调仓工具

### 4.1 核心原理

```
数学基础：1 YES + 1 NO = 1 USDC（无论市场价格如何）

原因：YES 和 NO 覆盖了事件的所有可能结果
  如果事件发生：1 YES = $1，1 NO = $0 → 合计 $1
  如果事件不发生：1 YES = $0，1 NO = $1 → 合计 $1

因此：
  持有 1 YES + 1 NO，任何时候都可以换回 $1 USDC
  这是无风险的确定性套利，不受当前价格影响

Merge 操作：
  把持有的 YES 和 NO 各取相同数量（min(YES, NO)）
  调用 CTF（Conditional Token Framework）合约
  合约返回等量的 USDC
```

### 4.2 什么时候出现双边持仓？

```
在正常做市过程中，买单（BID）和卖单（ASK）都会成交：
  你的 BID 成交 → 你买入了 YES → YES持仓增加
  你的 ASK 成交 → 你卖出了 YES，收到 USDC
    （等价于：你持有了 NO 的多头，因为你用 USDC 在 ASK 侧卖出 YES）

更直接的情况：
  你持有 YES（之前买入未卖出）
  平台给你匹配了一笔：你同时买入了 NO（直接操作）
  → 你同时持有 YES 和 NO

为什么会发生这种情况？
  市场趋势反转：先涨后跌，你先买了 YES，之后系统又在低位买了 NO
  系统自动对冲：某些版本的做市策略会主动买对立面来平衡
```

### 4.3 Merge 的完整操作流程

```
前置条件检查：
  YES持仓 > 0 AND NO持仓 > 0
  min(YES, NO) × 1 USDC > Gas成本（建议 > $100）
  距上次 Merge > 30 分钟（避免频繁链上操作）

操作流程：
  Step 1: 计算可 merge 数量
    merge_amount = min(YES持仓数量, NO持仓数量)

  Step 2: 调用 CTF 合约
    合约地址：0x4D97DCd97eC945f40cF65F87097ACe5EA0476045（Polygon 主网）
    函数：mergePositions(
      collateral   = USDC合约地址,
      parentCollection = bytes32(0)（根集合），
      conditionId  = 市场的 conditionId,
      partition    = [1, 2]（YES索引=1, NO索引=2）,
      amount       = merge_amount
    )

  Step 3: 确认收到 USDC
    等待交易确认（Polygon约 2-3 秒）
    账户 USDC 增加 merge_amount
    YES 减少 merge_amount，NO 减少 merge_amount

  Step 4: 更新本地持仓记录
    local_yes -= merge_amount
    local_no  -= merge_amount
    local_usdc += merge_amount
```

### 4.4 Merge vs. 直接市价卖出：如何选择

```
情况一：持有 YES=500, NO=0（单边持仓）
  → 不能 Merge（没有 NO）
  → 只能通过：
    A. Quote Skewing（让市场帮你慢慢卖）
    B. 限价单逐步卖出（成本低，但慢）
    C. 市价单（最快，但有滑点，最后手段）

情况二：持有 YES=300, NO=200（双边持仓）
  → 先 Merge 200 对：
    变为 YES=100, NO=0, USDC+=$200
  → 剩余 YES=100 再用 Quote Skewing 慢慢减仓
  → 优先 Merge 的原因：无滑点，100%确定，Gas成本极低

情况三：紧急情况（L3 风控触发，需要快速清仓）
  → Step 1: 先 Merge 所有能 Merge 的（最快无损）
  → Step 2: 剩余单边仓位用限价单挂出（尽量不用市价）
  → Step 3: 如果情况继续恶化，才用市价单（最后手段）

判断矩阵：
  有双边持仓？ → YES → 先 Merge（零成本）
  纯单边持仓？
    规模小且时间充裕 → Quote Skewing（优雅，不影响 Q-Score）
    规模大或紧急     → 限价单挂出（比市价便宜）
    极端紧急         → 市价单（接受滑点换速度）
```

### 4.5 Merge 的会计处理

```
场景：
  持有 YES=300（平均成本 0.48），NO=200（平均成本 0.54）
  进行 merge 200 对

会计分录（简化）：
  Merge 前净资产：
    YES价值 = 300 × 0.65（当前价格）= $195
    NO价值  = 200 × 0.35 = $70
    总计 $265

  Merge 操作：
    消耗 200 YES + 200 NO → 收回 $200 USDC

  Merge 后净资产：
    YES价值 = 100 × 0.65 = $65
    USDC = $200
    总计 $265（资产总量不变！）

  已实现收益计算：
    YES成本 = 200 × 0.48 = $96
    NO成本  = 200 × 0.54 = $108（这$108是你为NO支付的隐性成本）
    总投入  = $96 + $108 = $204（但实际账面不一定这么算，取决于记账方式）
    收回    = $200 USDC

  关键点：
    Merge 本身不"产生收益"，只是改变资产形式
    真正的收益/亏损取决于最初的买入成本
    Merge 让你把"浮动的市场敞口"变成"确定的USDC"
```

---

## 5. 三步调仓决策框架

### 5.1 完整决策树

```
每分钟执行一次持仓检查：

┌─────────────────────────────────────────────────────────────┐
│                    计算当前 IIR                               │
│                                                              │
│         IIR = (YES市值 - NO市值) / (YES市值 + NO市值)         │
└───────────────────────────┬─────────────────────────────────┘
                            │
              ┌─────────────┼─────────────┐
              ▼             ▼             ▼
         |IIR| < 0.3   |IIR| < 0.5   |IIR| < 0.75
              │             │             │
         【正常区间】    【偏高区间】   【危险区间】
              │             │             │
       轻微 Skewing   加强 Skewing +  减少偏向侧 80%
       (0.5 cents)    减少偏向侧 50%   + 评估 Merge
              │             │             │
              └─────────────┴─────┬───────┘
                                  │
                             |IIR| ≥ 0.75
                                  │
                            【紧急区间】
                                  │
                         取消所有挂单
                         人工评估减仓
```

### 5.2 分步执行的重要性

```
错误做法：一次性大规模调仓
  例：IIR = +0.7，一次性把 70% 的 YES 全卖出
  问题：
    大额市价单冲击价格
    自己在做空自己（卖出的同时，你的买单还在下方）
    可能触发 L2/L3 风控（成交量异常）

正确做法：分 3-5 次渐进调仓
  每次最多调整总持仓的 20%
  每次调仓之间等待 2-3 分钟，观察市场反应
  如果市场在朝有利方向自然移动，可以减少主动干预

渐进执行的逻辑：
  Step 1: Merge 操作（如果有双边持仓）→ 无损，最优先
  Step 2: Quote Skewing 调整 → 被动，市场帮你做
  Step 3: 减少偏向侧挂单规模 → 减少新增敞口
  Step 4: 限价单减仓（必要时）→ 主动但有成本
  Step 5: 市价单（极端情况）→ 最后手段
```

### 5.3 Merge 触发条件（详细）

```
触发 Merge 的检查（每分钟）：

条件1：双边持仓检查
  min(YES持仓, NO持仓) > 0

条件2：规模阈值
  min(YES持仓, NO持仓) × $1 > $100（Merge 后收回超过 $100 USDC）
  → 低于 $100，Gas 成本（~$0.01）虽然很低，但频繁操作增加复杂性

条件3：冷却时间
  距上次 Merge 操作 > 30 分钟
  → 避免过于频繁的链上操作

条件4：不在极端市场
  0.05 < adjusted_midpoint < 0.95
  → 极端概率市场的 YES/NO 价格失真，Merge 时机需要特别小心

伪代码：
  def should_merge(yes, no, last_merge_time, midpoint):
      merge_amount = min(yes, no)
      if merge_amount <= 100:
          return False  # 规模太小
      if time_now() - last_merge_time < 30 * 60:
          return False  # 冷却中
      if midpoint < 0.05 or midpoint > 0.95:
          return False  # 极端市场，跳过
      return True
```

---

## 6. 跨市场持仓管理

### 6.1 多市场同时做市时的总体限制

```
假设同时做 5 个市场，总资金 $10,000

总持仓限额：
  单市场最大仓位 = 总资金 × 20% = $2,000/市场
  全市场总敞口   = 各市场 YES 净多 + NO 净多 的总和 < 总资金 × 50%

为什么要限制总敞口？
  即使每个市场单独看都在风险范围内，
  多个市场同向暴露（都重仓 YES）时，
  一次全市场暴跌可以同时触发多个 L2/L3

风险计算：
  全市场 IIR = 所有市场净 YES 价值之和 / 总持仓价值
  建议：全市场 IIR 应控制在 ±0.3 以内
```

### 6.2 相关性风险

```
高相关性市场的风险：
  例：做市"拜登下台"和"民主党2024年大选"这两个市场
  这两个市场价格强相关，同向波动
  单独看每个市场 IIR 正常，但组合起来是双倍风险

低相关性市场的优势：
  做市完全不相关的市场（体育结果 + 科技事件 + 政治事件）
  各市场独立波动，风险自然对冲
  → 市场多样化是降低组合风险的有效手段

简单相关性判断（不需要复杂模型）：
  同类市场（同一体育联盟、同一政治人物）→ 高相关，需要控制总仓位
  跨类市场 → 低相关，可以各自独立管理
```

---

## 7. 小结：持仓管理的操作原则

| 原则 | 具体操作 | 为什么 |
|------|---------|--------|
| **IIR 实时监控** | 每分钟计算所有市场 IIR | 发现问题要在失控前 |
| **优先 Merge** | 有双边持仓就先 Merge | 零损耗，释放 USDC |
| **用 Skewing 不用市价** | 调整报价而非直接卖出 | 避免冲击，不影响 Q-Score |
| **分批渐进** | 每次最多调 20%，等待观察 | 避免自我冲击，留观察窗口 |
| **多市场多样化** | 跨类市场分散做市 | 降低相关性风险 |
| **硬性上限** | IIR > 0.75 必须停止新建仓 | 防止指数级风险积累 |
