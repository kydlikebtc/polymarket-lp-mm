# 三级风控体系

> 风控不是"紧急刹车"，而是**持续运行的安全系统**。
> 好的风控让你在 99% 的时间里自动运行，只在 1% 的极端情况下才需要人工介入。

---

## 1. 为什么需要分级风控

### 1.1 两种极端的问题

```
极端A：过于敏感的风控
  每次价格波动 2% 就撤单
  每天触发 50 次警报
  Q-Score 因频繁撤单损失严重
  奖励归零，但风险也被过度压制
  结论：策略无法运行，收益为零

极端B：过于迟钝的风控
  只在"快撑不住了"才触发
  一次 20% 价格跳跃把所有挂单吃空
  IIR 瞬间到 +1.0，浮亏超过月收益
  结论：一次事故抹平一个月利润

分级风控的目的：
  L1（日常）→ 完全自动，不打断做市节奏
  L2（预警）→ 自动收缩，通知人工关注
  L3（紧急）→ 全面停止，等待人工确认
```

### 1.2 分级的设计哲学

```
不同风险事件的性质不同，需要不同响应速度：

事件类型       时间尺度   是否可恢复   正确响应
─────────────────────────────────────────────────
价格小幅波动    秒级       是          自动调整挂单（L1）
持仓轻度失衡    分钟级     是          Skewing + 缩减规模（L1/L2边界）
价格快速跳跃    秒级       可能         自动收缩 + 通知（L2）
极端持仓失衡    分钟级     不确定       停止做市 + 人工（L3）
黑天鹅事件      秒级       不确定       立即全撤 + 人工（L3）
系统性攻击      实时       不可         紧急停止 + 调查（L3）
```

---

## 2. L1 级风控：日常自动运行

### 2.1 触发条件（所有条件都正常时处于 L1）

```
正常运营标准（所有条件同时满足）：
  ✓ 所有市场 |IIR| < 0.5
  ✓ 最近 5 分钟价格变动 < 10%
  ✓ 当日已实现+未实现 PnL > -3% × 总资金
  ✓ WebSocket 连接正常（断连时间 < 30s）
  ✓ 距当前做市市场结算时间 > 24h
```

### 2.2 L1 的持续操作（每 10 秒触发一次）

```
┌─ 价格追踪 ──────────────────────────────────────────────────┐
│                                                              │
│ if |adjusted_midpoint - last_update_price| > 0.005:         │
│     取消该市场旧挂单                                          │
│     按最新中间价重新计算阶梯报价                               │
│     提交新挂单                                               │
│                                                              │
│ elif time_since_last_update > 30s:                          │
│     定时刷新（即使价格没变，确保挂单仍有效）                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌─ 持仓检查 ──────────────────────────────────────────────────┐
│                                                              │
│ for each market in active_markets:                          │
│     iir = compute_iir(yes_value, no_value)                  │
│                                                              │
│     if |iir| < 0.3:                                         │
│         skew = iir × 0.005（轻微偏斜，0.5 cents）             │
│     elif |iir| < 0.5:                                       │
│         skew = iir × 0.015（加强偏斜，1.5 cents）             │
│         reduce_quote_size(偏向侧 × 0.5)                     │
│     else:                                                   │
│         → 升级到 L2 处理                                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌─ 结算预警 ──────────────────────────────────────────────────┐
│                                                              │
│ hours_to_resolution = market.resolve_time - now()           │
│                                                              │
│ if hours_to_resolution < 24:                                │
│     spread_multiplier × 2                                   │
│     quote_size × 0.5                                        │
│                                                              │
│ if hours_to_resolution < 2:                                 │
│     取消该市场所有挂单                                        │
│     从做市市场列表移除                                        │
│     记录日志："市场即将结算，已退出"                            │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌─ Merge 检查 ────────────────────────────────────────────────┐
│                                                              │
│ for each market:                                            │
│     if should_merge(yes, no, last_merge_time, midpoint):    │
│         execute_merge(market_id, min(yes, no))              │
│         last_merge_time = now()                             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 3. L2 级风控：预警与收缩

### 3.1 触发条件（任一满足即升级到 L2）

```
条件1：持仓失衡
  任意市场 |IIR| >= 0.5
  含义：这个市场已经积累了危险的单边仓位

条件2：价格异常波动
  任意市场 5分钟价格变化 |Δp| >= 10%
  含义：可能有重大新闻，知情交易者正在行动

条件3：当日亏损过大
  today_pnl < -0.03 × total_capital（日亏损超过 3%）
  含义：今天的策略表现异常，需要降低风险敞口

条件4：连接异常
  WebSocket 断连时间 >= 30s
  含义：看不到市场实时动态，盲目做市风险极高

条件5：市场临近结算（前 24h 特别警惕）
  0h < hours_to_resolution < 24h
  含义：结算前概率极化，极端行情风险急剧上升
```

### 3.2 L2 的自动响应（按顺序执行）

```
Step 1：停止进入新市场
  stop_market_discovery = True
  不再扫描新的做市机会，专注管理现有仓位

Step 2：全面收缩挂单规模
  for each market:
      cancel_all_orders(market)
      new_size = original_size × 0.5
      submit_new_orders(market, size=new_size, spread=spread×1.5)
  含义：减少资金敞口，同时扩大价差保护自己

Step 3：加强持仓监控频率
  monitoring_interval = 10s → 5s（更频繁检查）

Step 4：发送通知
  send_telegram("⚠️ L2 预警触发
    原因: {trigger_condition}
    时间: {timestamp}
    当前各市场 IIR: {iir_values}
    当日 PnL: {daily_pnl}
    建议操作: 关注后续走势")

Step 5：启动自动恢复监控
  # L2 可以自动恢复到 L1，不需要人工干预
  check_l2_recovery_conditions()
```

### 3.3 L2 恢复到 L1 的条件

```
以下所有条件同时满足，持续 5 分钟：
  ✓ 所有触发 L2 的条件都已消除
  ✓ 各市场 |IIR| < 0.4（比触发阈值更严格）
  ✓ 最近 5 分钟价格变化 < 5%（比触发阈值更严格）
  ✓ WebSocket 连接稳定
  ✓ PnL 没有继续恶化

恢复动作：
  stop_market_discovery = False
  逐步恢复挂单规模（每 5 分钟增加 10%，直到恢复到正常）
  发送通知："✅ L2 解除，系统恢复正常运行"

注意：恢复是渐进的，不是立即跳回 L1
  防止虚假恢复（价格短暂平稳后再次剧烈波动）
```

---

## 4. L3 级风控：紧急全停

### 4.1 触发条件（任一满足即升级到 L3）

```
条件1：极端持仓失衡
  任意市场 |IIR| >= 0.75
  含义：持仓已极度单边，再持有相当于在赌方向

条件2：极端价格跳跃
  任意市场 5分钟价格变化 |Δp| >= 20%
  含义：发生了重大事件，知情交易者已经扫光订单簿

条件3：当日巨额亏损
  today_pnl < -0.08 × total_capital（日亏损超过 8%）
  含义：策略出现严重问题，必须停止

条件4：疑似系统攻击（Ghost Fills）
  收到"订单被取消"事件，但对应的取消指令不是我发的
  含义：账户可能正在被攻击，需要立即保护

条件5：从 L2 状态持续恶化
  处于 L2 状态超过 2 小时，且情况没有改善
  含义：L2 的保守策略没有稳定局势，需要升级处理
```

### 4.2 L3 的紧急响应（并行执行，越快越好）

```
【优先级最高】立即撤单

  发送 DELETE /cancel-all 到 CLOB API
  这个操作取消你在所有市场的所有挂单
  不管其他操作是否完成，这个必须第一个执行

  原因：只要订单还在挂着，就还在承担风险
  哪怕网络慢，也要先发这个请求

【并行执行】停止策略引擎

  set_all_strategies_halted = True
  不再生成任何新的报价
  不再触发任何自动下单

【并行执行】发送紧急告警

  send_telegram("🚨 L3 紧急停止
    原因: {trigger_condition}
    时间: {timestamp}
    当前持仓快照: {position_snapshot}
    已执行: 全部撤单
    等待人工指令")

  如果配置了电话告警，同时触发电话通知

【完成后】记录完整快照

  save_snapshot({
      timestamp: now(),
      trigger_reason: reason,
      positions: all_positions,
      prices: all_midpoints,
      pnl: current_pnl,
      active_orders_before_cancel: orders_list
  })

  这个快照用于事后分析：是真实风险还是误报？
```

### 4.3 L3 期间的持仓处理

```
L3 触发后，挂单已全部取消，但持仓还在。
接下来如何处理持仓是人工决策的核心问题：

评估框架：

  Step 1: 检查各市场的双边持仓
    有双边持仓 → 立即执行 Merge（无风险操作）
    纯单边持仓 → 等待人工决策

  Step 2: 评估单边持仓风险
    持仓规模和当前价格
    距结算时间（如果很短，必须尽快处理）
    当前价格趋势（是否还在继续往不利方向走）

  Step 3: 人工决策选项
    选项A：保持持仓不动，等待价格回归
    选项B：限价单挂出，慢慢卖（成本低）
    选项C：市价单快速清仓（接受滑点，换确定性）

  没有标准答案，取决于：
    你对市场走向的判断
    持仓的浮亏规模（已经亏了多少）
    风险承受能力（再跌多少才会超出容忍）
```

### 4.4 L3 后的系统恢复（必须人工触发）

```
恢复流程（建议按顺序执行）：

1. 确认触发原因
   是市场正常波动还是真实黑天鹅？
   是误报（参数设置太敏感）还是真实风险？

2. 处理剩余持仓
   按 4.3 的框架处理
   确保持仓风险在可接受范围内

3. 检查系统完整性
   验证 WebSocket 连接正常
   验证 API Key 未被滥用（如果是攻击事件）
   验证账户余额与本地记录一致

4. 更新风控参数（如果需要）
   如果是参数设置问题，调整阈值
   如果是真实风险，考虑是否需要更保守的设置

5. 人工确认恢复
   在系统管理界面点击"确认恢复"按钮
   或发送特定的恢复命令

6. 渐进式重新做市
   先从 1-2 个市场开始，规模减半
   观察 30 分钟无异常，再逐步扩展
   7 天内完全恢复到正常规模

L3 → 任何状态 必须人工触发，系统不会自动恢复
```

---

## 5. Ghost Fills 攻击：检测与防护

### 5.1 攻击原理

```
背景：2026年2月，在 Polymarket 上发现的真实漏洞

Polymarket 的撮合机制：
  链下撮合：买卖双方在 CLOB 系统中匹配
  链上结算：匹配结果发到 Polygon 链上确认

攻击时间差：
  T=0: 攻击者下单 A → 你的挂单 B 被"匹配"
  T=1: 攻击者在链上结算前撤销订单 A
  T=2: 链上结算失败，你的挂单 B 被强制移出订单簿

结果：
  你的挂单被"取消"了，但你没有发任何取消指令
  在 User WebSocket 中，你会收到一个"CANCELED"事件
  但这个取消不是你触发的

攻击者的目的（推测）：
  通过反复攻击，让做市商的挂单持续失效
  使做市商的 Q-Score 归零（没有有效挂单就没有奖励）
  利用做市商 Q-Score 归零的时间段，独占奖励池
```

### 5.2 检测逻辑

```
核心原理：我知道我发了哪些取消请求，
         如果收到"取消"事件但没有对应的请求，就是异常

实现：维护一个本地取消请求集合

  my_cancel_requests = set()  # 存储我发出的所有取消请求

  # 每次发取消请求时记录
  def send_cancel(order_id):
      my_cancel_requests.add(order_id)
      api.delete_order(order_id)

  # 处理 WebSocket 事件
  def on_order_update(event):
      if event.type == "CANCELED":
          order_id = event.order_id

          if order_id in my_cancel_requests:
              # 正常取消，是我自己发的
              my_cancel_requests.remove(order_id)
              update_local_state(order_id, "canceled")
          else:
              # 异常！我没有发取消请求，但订单被取消了
              log.warning(f"Ghost Fill 检测！订单 {order_id} 被外部取消")
              ghost_fill_count += 1

              if ghost_fill_count >= 3:  # 超过阈值
                  trigger_l3_risk()
                  send_alert("疑似 Ghost Fill 攻击，已触发 L3")
```

### 5.3 防护措施

```
防御层1：实时检测（上面的逻辑）
  检测到异常立即触发 L3
  记录攻击时间、被攻击订单信息

防御层2：订单重建机制
  被取消的订单在排除攻击嫌疑后，自动重新提交
  确保 Q-Score 不因单次攻击而长期受损

防御层3：黑名单机制
  记录每次 Ghost Fill 事件的对手方地址（如果能获取）
  后续不接受来自这些地址的对手订单（如果平台支持）

防御层4：速率检测
  短时间内大量订单被异常取消 → 立即 L3
  单次偶发可能是网络问题，不必过度反应

防御层5：定期验证一致性
  每 5 分钟：对比本地活跃订单状态 vs API 查询结果
  如果发现本地有"活跃"但 API 显示已取消的订单
  → 说明漏掉了 WebSocket 事件 → 重同步状态
```

---

## 6. 风控状态机（完整）

### 6.1 状态转换图

```
                    ┌─────────────────────────────┐
                    │                             │
  系统启动           │         L1（正常）            │
  ──────────→        │   全自动，持续做市            │
                    │                             │
                    └──────────────┬──────────────┘
                                   │
                      任意L2触发条件满足
                                   │
                                   ▼
                    ┌──────────────────────────────┐
                    │         L2（预警）             │
                    │  自动收缩规模，通知人工          │
                    └──┬───────────────────────┬───┘
                       │                       │
              所有条件恢复              任意L3触发条件满足
              且保持5分钟稳定                   │
                       │                       ▼
                       │         ┌──────────────────────────┐
                       │         │         L3（紧急）         │
                       │         │  全撤单，停止做市，等人工   │
                       │         └──────────┬───────────────┘
                       │                    │
                       │              人工确认恢复
                       │                    │
                       └────────────────────┘
                                 │
                                 ▼
                    ┌─────────────────────────────┐
                    │    恢复流程（L1，减量运行）     │
                    │   30min观察 → 逐步扩展规模    │
                    └─────────────────────────────┘

关键规则：
  L1 → L2：自动（条件触发）
  L2 → L1：自动（条件恢复 + 5分钟稳定期）
  L2 → L3：自动（条件恶化）
  L3 → 任何：必须人工确认
```

### 6.2 阈值汇总表

```
指标                 L2 触发阈值    L3 触发阈值    说明
────────────────────────────────────────────────────────
单市场 |IIR|         ≥ 0.5         ≥ 0.75        持仓失衡比率
5分钟价格变化         ≥ 10%         ≥ 20%         快速价格跳跃
当日 PnL/资本         ≤ -3%         ≤ -8%         亏损率
WebSocket 断连        ≥ 30s         N/A           连接稳定性
L2持续时间            N/A           ≥ 120min      L2降级超时
Ghost Fill次数        N/A           ≥ 3次/30min   攻击检测
距结算时间            < 24h特别注意   N/A           时间风险
────────────────────────────────────────────────────────
```

---

## 7. 事件检测：价格就是最好的预警

### 7.1 为什么不用新闻源？

```
直觉：监控新闻，发现新闻 → 先撤单，再等价格变化
现实：价格比新闻快

时序对比：
  T=0  某新闻发布（例如选举结果出来）
  T+1s 在 Polymarket 看市场的知情交易者开始扫单
  T+5s 价格已经跳动 15%
  T+30s 新闻在 Twitter 上广泛传播
  T+2min 新闻出现在主流媒体
  T+5min 你的新闻爬虫检测到这条新闻

结论：等新闻来保护自己已经太晚了。
      价格的异常变动本身就是最快的信号。
```

### 7.2 价格异常检测算法

```
检测逻辑（每 60 秒运行）：

def detect_price_anomaly(market_id):
    # 获取最近 5 分钟的价格序列
    prices_5min = get_price_history(market_id, minutes=5)

    # 计算价格变化幅度
    price_change = abs(prices_5min[-1] - prices_5min[0])

    # 计算速率（异常快速的变化更危险）
    price_velocity = price_change / len(prices_5min)

    if price_change >= 0.20:
        trigger_l3(market_id, "价格5分钟跳动超过20%")
    elif price_change >= 0.10:
        trigger_l2(market_id, "价格5分钟跳动超过10%")
    elif price_velocity > 0.01 per minute:
        # 速率异常，即使绝对变化不大
        log.warning(f"价格变动速率异常: {price_velocity}")
```

### 7.3 成交量异常检测（进阶）

```
正常情况：成交量均匀分布在一天中
异常情况：某个 5 分钟窗口的成交量是日均的 5 倍+

检测：
  hourly_avg_volume = daily_volume / 24
  if last_5min_volume > hourly_avg_volume * 2:
      log.warning("成交量异常，可能有大户行动")
      # 不一定触发 L2，但增加监控频率

结合使用：
  价格变化 > 5% AND 成交量异常 → 几乎确定有重大消息
  价格变化 > 5% but 成交量正常 → 可能是单一大户操作，稍微放松
```

---

## 8. 系统监控指标（完整列表）

```
每分钟记录：
  - 各市场 adjusted_midpoint
  - 各市场 |IIR|
  - 当前风控状态（L1/L2/L3）
  - 活跃挂单数量
  - WebSocket 最后收到消息时间

每 10 分钟记录：
  - 累计已实现 PnL
  - 各市场预估 Q-Score（基于当前挂单计算）
  - Merge 操作累计次数和回收 USDC 总量

每小时发送 Telegram 报告：
  - 各市场当前状态
  - 当日 PnL 进展
  - 预估奖励收入

异常时立即发送：
  - L2/L3 触发告警
  - WebSocket 断连告警
  - Ghost Fill 检测告警
  - 任意市场价格跳动 > 10% 告警
```

---

## 9. 小结：风控系统的核心原则

| 原则 | 说明 |
|------|------|
| **分级响应** | 不同严重程度用不同的自动化程度响应 |
| **快速撤单优先** | L3 下，撤单是第一优先，其他都是其次 |
| **L3 必须人工恢复** | 自动恢复可能让系统在不安全状态下继续运行 |
| **价格是最好的预警** | 不依赖新闻源，价格变化本身是最快的信号 |
| **Ghost Fill 专项防护** | 维护本地取消请求集合，实时对比异常 |
| **渐进恢复** | L3 后不立即全量重启，观察后逐步扩展 |
| **日志完整** | 每个关键决策都要记录原因，方便事后复盘 |
