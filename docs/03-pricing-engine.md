# 定价引擎与阶梯挂单

> 价格不是随便报的。好的定价引擎要同时回答三个问题：
> **挂在哪**（距中间价多少），**挂多少**（每层规模），**何时更新**（触发条件）。

---

## 1. 基础价差的确定：最低安全线

### 1.1 逆向选择成本

```
做市商最大的风险是"被知情交易者占便宜"：

  场景：
    你在 0.51 挂了一个卖单（ASK）
    一个知道"YES 概率其实有 70%"的交易者买了你的单
    价格很快从 0.51 涨到 0.70
    你卖出了一个本来值 $0.70 的东西，只收到 $0.51

    损失 = 0.70 - 0.51 = $0.19 per share
    这就是逆向选择损失（Adverse Selection Loss）

最小安全价差 = 补偿逆向选择损失的最低价差

估算公式（简化）：
  safe_half_spread ≥ 1.96 × σ_daily × √(holding_time / 1_day)

  σ_daily = 历史日波动率（例如 3% = 0.03）
  holding_time = 预期持仓时间（做市商通常 2-6 小时）
  1.96 = 95% 置信区间系数

举例：
  σ_daily = 0.03，holding_time = 4小时
  safe_half_spread = 1.96 × 0.03 × √(4/24) = 1.96 × 0.03 × 0.408 ≈ 0.024

  安全价差（单侧）≈ 2.4 cents
  这意味着：最内层挂单应该距中间价至少 2.4 cents（保守）
  实战中通常取 1-2 cents（因为还有奖励覆盖部分风险）
```

### 1.2 奖励如何改变最小价差

```
Q-Score 奖励改变了做市的 PnL 方程：

没有奖励的情况：
  做市 PnL = 价差收益 - 逆向选择损失
  要求：价差收益 > 逆向选择损失 → 挂单要宽

有奖励的情况：
  做市 PnL = 价差收益 - 逆向选择损失 + Q-Score奖励
  奖励可以覆盖部分逆向选择损失 → 挂单可以更窄

实际影响：
  高奖励密度市场：可以挂 0.5-1 cent 的极窄价差
  低奖励密度市场：需要 2-3 cents 的价差

  因此：选市场时，先看激励密度，再决定价差策略
```

---

## 2. 动态价差：根据市场状态实时调整

### 2.1 三个调整因子

```
实际价差 = 基础价差 × 波动率因子（VAF）× 失衡因子（IIF）× 时间因子（TF）

每次重新挂单时都重新计算这三个因子
```

### 2.2 波动率因子（Volatility Adjustment Factor, VAF）

```
VAF 的作用：在市场波动加大时自动拉宽价差，保护自己

计算方法：
  recent_volatility = 最近1小时的5分钟价格标准差（年化）
  baseline_volatility = 最近7天的日波动率基准
  VAF = recent_volatility / baseline_volatility

举例：
  过去7天：市场每天波动 2-3%，baseline_volatility = 0.025
  今天最近1小时：波动异常，recent_volatility = 0.060
  VAF = 0.060 / 0.025 = 2.4

  如果基础价差是 1 cent，调整后 = 1 × 2.4 = 2.4 cents

限制条件：
  VAF 最小值 = 0.8（不能因市场太平静就挂太窄的单）
  VAF 最大值 = 5.0（不能因波动大就超出 max_spread）
  最终价差不能超过 max_incentive_spread（否则不得奖励）

实现细节：
  def compute_vaf(recent_vol, baseline_vol):
      raw_vaf = recent_vol / baseline_vol
      return max(0.8, min(5.0, raw_vaf))
```

### 2.3 失衡因子（Imbalance Factor, IIF）

```
IIF 的作用：在持仓失衡时，不对称地调整两侧的价差

  IIR > 0（持有过多 YES）→ 卖单 ASK 拉近（更愿意卖），买单 BID 推远（不想再买）
  IIR < 0（持有过多 NO）→ 买单 BID 拉近（更愿意买 YES），卖单 ASK 推远

公式：
  IIR = 当前持仓失衡比率（-1 到 +1）

  bid_adjustment = -IIR × 0.01（IIR正时，bid价格降低，更难成交）
  ask_adjustment = -IIR × 0.01（IIR正时，ask价格降低，更容易成交）

  实际上这就是 Quote Skewing，只是表达为价差调整因子的形式

注意：IIF 不改变价差宽度，只改变价格中心（同向移动 bid 和 ask）
```

### 2.4 时间因子（Time Factor, TF）

```
TF 的作用：随着结算临近，强制拉宽价差，防止结算前被"知情"

  距结算时间 h（小时）→ TF

  h > 24:    TF = 1.0   （正常）
  12 < h ≤ 24: TF = 1.5   （轻微加宽）
  6  < h ≤ 12: TF = 2.0   （明显加宽）
  2  < h ≤ 6:  TF = 3.0   （大幅加宽）
  h ≤ 2:    停止做市       （退出，取消所有单）

原因：
  结算前，价格会剧烈趋向 0 或 1
  知情交易者（知道结果的人）会大量单向扫仓
  做市商必须用宽价差保护自己，或直接退出
```

---

## 3. 阶梯挂单：为什么要分层

### 3.1 阶梯的核心逻辑

```
问题：把 $1000 全放在距中间价 0.5 cents 的位置行不行？

  看起来可以：距离最近，Q-Score 最高
  问题1：太薄，容易被一笔大单全部吃掉，然后你没有订单
  问题2：一旦价格稍微偏移 0.5 cents，订单全部脱离有效范围

解决：阶梯结构

  内层：少量资金，最接近中间价
    目的：确保 Q-Score，频繁成交和重建
    风险：成交后无缓冲，需要快速重建

  中层：中等资金，中等距离
    目的：提供流动性缓冲，稳定 Q-Score
    风险：奖励效率中等

  外层：较多资金，距离中间价较远
    目的：极端行情缓冲，不是为了奖励
    风险：奖励效率很低，但保护内层
```

### 3.2 三层标准结构（以 $1000 为例）

```
市场参数：
  adjusted_midpoint = 0.500
  max_incentive_spread = 3 cents（0.03）
  基础半价差 = 1 cent（0.01），即整体价差 2 cents

阶梯设计：

层级   距中间价   单侧规模   双侧总规模   Q-Score 效率
────────────────────────────────────────────────────────
L1     0.5 cents  $100       $200         100% × (0.025/0.03)² ≈ 69%
L2     1.5 cents  $200       $400         (0.015/0.03)² ≈ 25%
L3     2.5 cents  $200       $400         (0.005/0.03)² ≈ 3%

总计单侧 $500，双侧 $1000

具体挂单：
BID侧（买 YES）：
  bid@0.495  $100   （中间价 - 0.5 cents）
  bid@0.485  $200   （中间价 - 1.5 cents）
  bid@0.475  $200   （中间价 - 2.5 cents）

ASK侧（卖 YES）：
  ask@0.505  $100   （中间价 + 0.5 cents）
  ask@0.515  $200   （中间价 + 1.5 cents）
  ask@0.525  $200   （中间价 + 2.5 cents）
```

### 3.3 资金分配的数学依据

```
问题：内层放多少，外层放多少？

Q-Score 贡献分析（以上面的例子）：

  L1 ($100 each side)：
    Q = (0.025/0.03)² × 100 × 2 = 0.694 × 200 ≈ 138.9
    奖励占比（估算）≈ 占总 Q 的 75%

  L2 ($200 each side)：
    Q = (0.015/0.03)² × 200 × 2 = 0.25 × 400 ≈ 100.0
    奖励占比 ≈ 占总 Q 的 20%

  L3 ($200 each side)：
    Q = (0.005/0.03)² × 200 × 2 = 0.028 × 400 ≈ 11.1
    奖励占比 ≈ 占总 Q 的 5%

  总 Q ≈ 250（整体）

结论：
  75% 的奖励来自 L1（只占资金的 20%）
  L3 资金占比 40%，但奖励贡献只有 5%
  → L3 的钱主要买的是"极端行情保护"，不是奖励
```

### 3.4 为什么外层用大单？

```
场景：突发利空消息，价格从 0.50 快速下跌

情形A：均匀分布（每层 $333）
  L1 bid@0.495：被吃掉 $333
  L2 bid@0.485：被吃掉 $333
  L3 bid@0.475：被吃掉 $333
  → 总共买入 $999 YES，平均成本 0.485
  → 你在不停的买，直到全部被吃光，IIR 直接到 +1

情形B：阶梯（L1=$200，L2=$400，L3=$800）[外层大单版本]
  L1 bid@0.495：被吃掉 $200（小单，损失小）
  L2 bid@0.485：被吃掉 $400
  L3 bid@0.475：开始被吃 $800 时...
  → 在 L3 大单被吃一半时，"价格下跌速度"触发 L2 预警
  → 系统自动取消 L3 剩余 $400 的买单
  → 实际总买入 $200 + $400 + $400 = $1000，但止住了

  更重要的是：大单给了反应时间
  L3 的 $800 大单在一定程度上减缓了价格下跌（你在吃对手卖单）
  这个减缓给了系统检测到异常并触发撤单的时间窗口

实战中的外层比例：
  内层 : 中层 : 外层 = 1 : 2 : 3 到 1 : 2 : 4 都合理
  具体取决于资金规模和风险偏好
```

---

## 4. 挂单更新触发逻辑

### 4.1 三种触发场景

```
场景1：价格移动触发（最常见）
  监控条件：|adjusted_midpoint - last_order_midpoint| > price_threshold
  建议阈值：0.005（0.5 cents）

  原因：中间价移动 0.5 cents 后，你的挂单和新中间价的距离都变了
  L1 内层可能已经超出 max_spread（没有奖励了）
  或者 L1 内层价格对对手方来说太有吸引力（被立即吃掉的风险）

场景2：定时触发（兜底机制）
  每隔 30 秒，即使价格没有大幅移动，也刷新一次挂单

  原因：
    网络问题可能导致 WebSocket 价格更新延迟
    保证挂单的时效性
    维持与订单簿的同步状态

场景3：持仓变化触发（主动调整）
  当 IIR 变化超过 0.1 时（例如从 0.2 变到 0.3）
  触发重新生成带偏斜的挂单

  原因：持仓变了，报价的偏斜方向和力度需要更新
```

### 4.2 更新的完整流程

```
触发更新 → 执行以下步骤（每次都是"撤旧立新"）：

Step 1: 取消当前该市场所有挂单
  POST /cancel-market-orders
  Body: { market: market_id }

  注意：这是一次性取消整个市场的所有订单
  比一个个取消快得多

Step 2: 等待取消确认
  通过 User WebSocket 监听，直到所有订单状态变为 CANCELED
  超时处理：5 秒后如果未全部确认，继续执行（容忍少量未确认）

Step 3: 计算新挂单参数
  latest_midpoint = get_latest_adjusted_midpoint()
  vaf = compute_vaf(...)
  iir = compute_iir(...)
  skew = iir × skew_factor

  for each layer in ladder_config:
      bid_price = (latest_midpoint - layer.distance × vaf × tf) - skew
      ask_price = (latest_midpoint + layer.distance × vaf × tf) - skew
      bid_size = layer.base_size（按 IIF 可能调整）
      ask_size = layer.base_size

Step 4: 提交新挂单（批量）
  orders = []
  for each layer:
      orders.append(create_bid_order(bid_price, bid_size))
      orders.append(create_ask_order(ask_price, ask_size))

  # 最多 15 个一批（Polymarket API 限制）
  for batch in chunks(orders, 15):
      POST /order
      Body: { orders: batch }

Step 5: 记录更新
  last_order_midpoint = latest_midpoint
  last_update_time = now()
  log.info(f"挂单已更新，中间价: {latest_midpoint}, VAF: {vaf}")
```

### 4.3 API 限流控制

```
Polymarket 的限制：
  3000 次请求 / 10 分钟窗口（滑动窗口）
  = 平均每分钟 300 次，每秒 5 次

单次更新的 API 消耗：
  取消请求：1 次
  下单请求：ceil(挂单数 / 15) 次
  例：6个市场，每市场6笔单 = 36单 → ceil(36/15) = 3 次下单请求
  每次更新总计：1 + 3 = 4 次请求

在 6 个市场同时更新时的频率：
  每次更新 = 4 次
  如果每 30 秒更新一次：4 × 2 = 8 次/分钟（远低于限制）
  如果价格剧烈波动，每 10 秒更新一次：4 × 6 = 24 次/分钟（仍在限制内）

安全边际：
  正常情况下 API 使用率 < 10%，有充足余量应对高频波动
  如果 API 调用接近限制，自动降低更新频率（延长等待窗口）
```

---

## 5. 市场筛选：先选市场，再定价

### 5.1 激励密度的完整计算

```
Step 1: 获取市场基本奖励信息（Gamma API）
  GET https://gamma-api.polymarket.com/markets

  关键字段：
    rewards.dailyRewardTokenAmount → 日奖励 USD 金额
    rewards.maxSpread              → max_incentive_spread
    rewards.minSize                → 每笔最小合格订单规模

Step 2: 估算市场当前总合格流动性（CLOB API）
  GET https://clob.polymarket.com/book?token_id={YES_token_id}

  获取订单簿深度，计算在 max_spread 范围内的所有挂单总量：
  qualifying_liquidity = sum(
      order.size for order in orderbook
      if |order.price - midpoint| < max_spread
  )

Step 3: 计算激励密度
  incentive_density = daily_reward_usd / qualifying_liquidity

  高密度示例：
    日奖励 $100，合格流动性 $5,000 → 密度 = 2%
    你投入 $1000 → 占比约 20% → 日奖励约 $20

  低密度示例：
    日奖励 $200，合格流动性 $200,000 → 密度 = 0.1%
    你投入 $1000 → 占比约 0.5% → 日奖励约 $1
```

### 5.2 其他筛选条件

```
筛选条件（建议的最低标准）：

  ✓ 24h成交量 > $50,000
    原因：成交量低意味着你的挂单很难成交，价差收益几乎为零

  ✓ 价差 < 5 cents
    原因：价差大说明其他做市商不愿做，可能有信息不对称风险

  ✓ 距结算时间 > 7 天
    原因：时间太短，奖励累计时间不够，极端行情风险高

  ✓ 中间价在 [0.10, 0.90] 之间
    原因：极端概率市场波动性失常，而且双边挂单条件更苛刻
    如果市场价格 < 0.10 或 > 0.90，必须双边且挂单难度更高

  ✓ 激励密度 > 0.5%/天（目标值，不是硬性要求）
    原因：低于这个值，奖励 APY 低于 100%，不如换市场
```

### 5.3 市场切换策略

```
做市商需要持续监控激励密度变化：

  密度下降的原因：
    新的做市商发现了这个市场，开始竞争
    奖励池减少（赞助商奖励到期）
    流动性大幅增加（市场变热门）

  何时切换：
    激励密度 < 0.3%/天，且有更好的备选市场
    连续 3 天密度持续下降

  切换步骤：
    Step 1: 在当前市场维持做市（不立即撤出）
    Step 2: 同时开始在新市场建仓（分批，不影响当前市场）
    Step 3: 当前市场仓位自然消化后，停止更新挂单
    Step 4: 完全退出（最后的挂单成交或撤销）

  注意：不要急着切换
    切换过程中两个市场都需要关注
    新市场建仓初期 Q-Score 低（仓位小）
    渐进式切换可以减少奖励损失
```

---

## 6. 极端情况的处理

### 6.1 订单簿一侧为空

```
情况：市场只有买单，没有卖单（或反之）

原因：
  临近结算，大家都不想做某一侧
  极端概率市场（如价格 0.02）

处理：
  一侧为空 → adjusted_midpoint 使用历史价格或上次成交价
  你仍然可以挂单，但要用更宽的价差（保守）
  这种情况下 VAF 会自动放大，价差自然加宽

  如果连参考中间价都无法确定（两侧都为空）：
    → 暂停该市场做市
    → 每隔 5 分钟检查一次，等待订单簿恢复
```

### 6.2 价格接近边界（< 0.03 或 > 0.97）

```
当价格趋向极端时：

  价格 = 0.05（YES 只有 5% 概率）：
    max_spread 范围内你能挂的 BID 价格：0.05 ± 0.03
    ASK 侧最低只能挂 0.01（Polymarket 限制 ≥ 0.01）
    BID 侧最低也只能挂 0.01

  实际上 BID 侧的空间非常有限（0.05 - 0.03 = 0.02，距 0.01 只有 0.01）
  做市空间极窄 → 奖励竞争激烈 → 通常不值得

  建议：价格 < 0.05 或 > 0.95 的市场，不要新进入
  已经在做的市场：在此价格区间触发结算预警，逐步退出
```

---

## 7. 小结：定价引擎的核心参数

| 参数 | 建议值 | 说明 |
|------|--------|------|
| **基础内层距离** | 0.5-1 cent | 最靠近中间价，Q-Score 最高 |
| **基础中层距离** | 1.5-2 cents | 缓冲层 |
| **基础外层距离** | 2.5 cents | 接近 max_spread，极端缓冲 |
| **VAF 上限** | 5.0 | 不允许无限扩大价差 |
| **VAF 下限** | 0.8 | 不允许无限缩小价差 |
| **Skew Factor** | 0.02 | IIR 每单位对应 2 cents 偏斜 |
| **更新阈值** | 0.5 cents | 价格变化超过此值才更新挂单 |
| **定时更新** | 30 秒 | 保证挂单时效性的兜底 |
| **内层规模比例** | 20% 总资金/侧 | 主力资金放内层 |
| **外层规模比例** | 40% 总资金/侧 | 保护性大单放外层 |
