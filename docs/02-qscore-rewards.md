# Q-Score 与奖励机制

> 这是整个做市策略的**收益基础**。理解 Q-Score 的数学，才能理解为什么要
> 阶梯挂单、为什么要双边、为什么内层小单比外层大单更"值钱"。

---

## 1. Q-Score 是什么

Q-Score 是 Polymarket 用来衡量**做市商挂单质量**的指标。
平台每分钟对所有做市商的活跃挂单评分一次，按各人的比例分配当日奖励池。

```
你的日奖励 = (你的日均 Q-Score / 全体做市商日均 Q-Score 之和) × 该市场日奖励池

"日均" = 当天 1440 次快照（每分钟一次）的平均值
```

---

## 2. Q-Score 计算公式（完整）

### 2.1 单笔挂单的得分

```
单笔得分 = ((max_spread - order_spread) / max_spread)² × order_size

参数：
  max_spread   = 市场设定的最大激励价差（通常 3 cents = 0.03）
  order_spread = |你的挂单价格 - adjusted_midpoint|
  order_size   = 挂单的 USDC 规模

条件：
  若 order_spread >= max_spread → 得分 = 0（超出范围，不计奖励）
```

### 2.2 双边惩罚规则

```
情况1：中间价在 [0.10, 0.90] 区间（正常市场）
  只挂 BID（买单）：市场总得分 = Q_bid / 3
  只挂 ASK（卖单）：市场总得分 = Q_ask / 3
  双边都挂：         市场总得分 = Q_bid + Q_ask（不惩罚）

情况2：中间价在 [0, 0.10) 或 (0.90, 1.0] 区间（极端概率市场）
  必须双边都挂，否则 Q = 0（完全没有奖励）
```

### 2.3 一次快照的完整计算示例

```
假设：max_spread = 3 cents，adjusted_midpoint = 0.50

你当前挂单：
  bid@0.489  $200   → order_spread = 0.50 - 0.489 = 0.011
  bid@0.475  $100   → order_spread = 0.50 - 0.475 = 0.025
  ask@0.511  $200   → order_spread = 0.511 - 0.50 = 0.011
  ask@0.525  $100   → order_spread = 0.525 - 0.50 = 0.025

各笔得分：
  bid@0.489: ((0.03 - 0.011) / 0.03)² × 200 = (0.633)² × 200 = 80.2 分
  bid@0.475: ((0.03 - 0.025) / 0.03)² × 100 = (0.167)² × 100 = 2.8 分
  ask@0.511: 同 bid@0.489 → 80.2 分
  ask@0.525: 同 bid@0.475 → 2.8 分

双边都有挂单 → 不触发惩罚
本次快照 Q-Score = 80.2 + 2.8 + 80.2 + 2.8 = 166.0 分
```

---

## 3. 二次衰减：为什么"靠近"如此重要

Q-Score 公式的核心是**平方项（²）**，导致奖励随距离**指数级**下降：

```
以 max_spread = 3 cents 为例，挂单 $100：

距中间价     公式计算                  得分    相对最大值
─────────────────────────────────────────────────────────
0.0 cents   (3/3)² × 100 = 1.000 × 100   100.0   100%
0.5 cents   (2.5/3)² × 100 = 0.694 × 100  69.4    69%
1.0 cents   (2/3)² × 100 = 0.444 × 100    44.4    44%
1.5 cents   (1.5/3)² × 100 = 0.250 × 100  25.0    25%
2.0 cents   (1/3)² × 100 = 0.111 × 100    11.1    11%
2.5 cents   (0.5/3)² × 100 = 0.028 × 100   2.8     3%
3.0 cents   (0/3)² × 100 = 0.000 × 100     0.0     0%
─────────────────────────────────────────────────────────
```

**直观理解：**
- 从中间价往外移动 1 cent，得分从 100% 降到 44%（损失 56%）
- 再往外移动 1 cent（到 2 cents），得分从 44% 降到 11%（再损失 75%）
- 外层的单位资金奖励效率极低

### 为什么阶梯挂单用"内层小单 + 外层大单"？

```
资金分配逻辑：

内层（0~1 cent）：  奖励效率高 → 放主力资金，持续赚 Q-Score
外层（1~3 cents）： 奖励效率低 → 放少量资金，目的是缓冲大行情

错误做法：把资金均匀分布在各层
  内层 $200 + 中层 $200 + 外层 $200 → Q-Score 由内层主导，但外层浪费奖励效率

正确做法：大量资金集中在内层
  内层 $500 + 中层 $300 + 外层 $200 → 最大化 Q-Score，外层只做保护用
```

---

## 4. 双边挂单的价值：不是 2 倍，而是 3 倍

### 4.1 数字对比

假设你有 $200，想在某市场做市。

**方案 A：全部买单（单边）**
```
挂 bid@0.489 $200
Q = ((0.03 - 0.011) / 0.03)² × 200 / 3
  = (0.633)² × 200 / 3
  = 80.2 / 3
  = 26.7 分（惩罚除以3）
```

**方案 B：双边各 $100**
```
挂 bid@0.489 $100 + ask@0.511 $100
Q = ((0.633)² × 100) + ((0.633)² × 100)
  = 40.1 + 40.1
  = 80.2 分（不惩罚）
```

**结论：相同的 $200，方案 B 的 Q-Score 是方案 A 的 3 倍。**

### 4.2 为什么平台要这样设计？

平台的目标是让做市商**提供双边流动性**：
- 只有买单 → 买家（想买 YES）来了有人卖，但卖家（想卖 YES）来了没地方卖
- 只有卖单 → 反过来
- 双边都有 → 任何方向的交易者都能成交，市场真正活跃

单边挂单是"搭便车"行为（享受奖励但不承担双边义务），平台用 3 倍惩罚纠正这种行为。

### 4.3 实际操作：双边不需要完全对称

```
双边的要求是"两侧都有挂单"，不要求数量相等。

允许：bid $300 + ask $100（偏向买侧）→ 不触发惩罚
允许：bid $100 + ask $100 → 完全对称

这给了做市商空间：
  当持有过多 YES 时，可以减少 ask 侧（不那么积极卖 YES）
  当持有过多 NO 时，可以减少 bid 侧（不那么积极买 YES）
  只要两侧都有，就不触发惩罚
```

---

## 5. 激励密度：选择市场的核心指标

### 5.1 为什么不能只看"日奖励总额"

```
市场 A：日奖励池 $500，但已有 $500,000 的流动性竞争
  你投入 $1,000 → 占比 0.2% → 日奖励 ≈ $1

市场 B：日奖励池 $100，只有 $10,000 的流动性
  你投入 $1,000 → 占比 10% → 日奖励 ≈ $10

→ 市场 B 是市场 A 的 10 倍效率！
```

### 5.2 激励密度的计算

```
激励密度 = 市场日奖励池 / 市场当前总合格流动性

高密度市场的特征：
  - 奖励池较大（市场重要或赞助商加了额外奖励）
  - 当前做市商少（市场相对冷门，别人没发现）

寻找"奖励大、竞争少"的市场，是市场筛选的本质目标
```

### 5.3 通过 API 获取所需数据

```
从 Gamma API 获取：
  rewardsMinSize        → 每笔订单的最小合格规模（通常 5 USDC）
  rewardsMaxSpread      → max_spread，超出此范围不得奖励
  dailyRewardUsdAmount  → 日奖励总额（美元）

从 CLOB API 估算流动性：
  GET /book?token_id=xxx → 订单簿深度
  总合格流动性 ≈ 订单簿内 max_spread 范围内的所有订单量之和

激励密度 = dailyRewardUsdAmount / 总合格流动性
```

---

## 6. Adjusted Midpoint：不是普通的中间价

### 6.1 为什么不用 last_trade_price

```
last_trade_price（最近成交价）的问题：
  - 有时间延迟（上次成交可能是几分钟前）
  - 可能被小额成交人为拉偏
  - 不能反映当前市场的真实中心

Adjusted Midpoint 的计算（Polymarket 官方实现）：
  adjusted_mid = (best_bid + best_ask) / 2

  但会进行调整：
  - 如果 best_bid 或 best_ask 不存在（订单簿一侧为空）→ 使用历史价格
  - 边界处理：不允许超过 [0.01, 0.99]
```

### 6.2 对做市商的实际影响

```
你的挂单是否能获得 Q-Score，取决于：
  |你的价格 - adjusted_midpoint| 是否 < max_spread

因此：
  你需要实时追踪 adjusted_midpoint
  每次中间价变动时，重新计算你的挂单是否还在激励范围内
  如果中间价移动超过 0.5 cents，需要更新挂单（撤旧立新）
```

---

## 7. 奖励的时间维度

```
采样：每分钟采样一次（1440 次/天，10080 次/周）

计算：当天的奖励 = 1440 次快照的平均 Q-Score

结算：每日 UTC 00:00 结算前一日奖励，发放到账户

最低发放门槛：$1（低于 $1 的奖励不发放，累积到下日）

关键含义：
  如果你在 12:00~23:59 才开始挂单，只有一半的快照数量
  → 奖励只有全天挂单的一半

  如果你在某小时撤单后没有重新挂，这段时间的快照 Q-Score = 0
  → 奖励按实际在线时间比例减少

  结论：尽量保持 7x24 小时挂单，每分钟都在线才能最大化奖励
```

---

## 8. 竞争动态：奖励随参与者增多而减少

```
奖励池总量固定，参与者越多，每人分到的越少。

模拟：某市场日奖励 $100，你投入 $1,000

情况1：只有你一个做市商
  你的 Q-Score 占比 ≈ 100% → 日奖励 ≈ $100
  年化回报 = $100 × 365 / $1000 = 3650%（不可能持续）

情况2：5 个做市商，资金规模相近
  你的占比 ≈ 20% → 日奖励 ≈ $20
  年化 = $20 × 365 / $1000 = 730%（早期进入的红利）

情况3：20 个做市商
  你的占比 ≈ 5% → 日奖励 ≈ $5
  年化 = $5 × 365 / $1000 = 183%（竞争加剧后）

情况4：50 个做市商（充分竞争）
  你的占比 ≈ 2% → 日奖励 ≈ $2
  年化 = $2 × 365 / $1000 = 73%（接近均衡状态）

结论：
  新市场、冷门市场 = 先发优势明显
  市场筛选的本质：找到竞争者少的高密度市场
  随着参与者增多，需要不断切换到新的低竞争市场
```

---

## 9. 奖励之外的收益：价差收益

```
价差收益（Spread Income）= 买入价格低于卖出价格时的差价

举例：
  你挂 bid@0.489，成交了 100 USDC
  你挂 ask@0.511，成交了 100 USDC
  价差收益 = (0.511 - 0.489) × 成交数量 = 0.022 × 成交量

但价差收益有逆向选择风险：
  如果知情交易者在 0.511 大量买入（他们知道概率远不止 51%），
  你卖出了 YES，之后价格涨到 0.80，你亏损了 (0.80-0.511) × 数量

因此：
  价差收益 ≠ 净收益
  实际净价差收益 = 价差收益 - 逆向选择损失
  当市场平稳时净价差收益为正；事件发生时可能为负
```

---

## 10. 小结：最大化奖励的操作原则

| 原则 | 为什么 |
|------|--------|
| **双边挂单，不能只挂一侧** | 单边惩罚系数 ÷ 3，奖励损失 2/3 |
| **主力资金放最靠近中间价** | Q-Score 二次衰减，内层效率远高于外层 |
| **实时追踪 adjusted_midpoint** | 中间价移动后旧单得分归零 |
| **选激励密度高的市场** | 同样资金，密度高的市场回报高 |
| **7x24 保持挂单** | 奖励按在线时间比例计算 |
| **避免极端概率市场（<10% 或 >90%）** | 必须双边才有奖励，且波动率高 |
