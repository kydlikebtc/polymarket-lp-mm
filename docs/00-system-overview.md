# 系统总览：Polymarket LP 做市机器人

> 本文档描述整个系统的运作原理、模块划分和数据流向。
> 先读这篇，再读各模块的详细说明文档。

---

## 1. 做市商的核心价值和盈利逻辑

### 1.1 做市商是什么

做市商（Market Maker，MM）是在订单簿两侧同时挂单的参与者：
- 在买单侧（BID）挂单：愿意以某价格**买入** YES 代币
- 在卖单侧（ASK）挂单：愿意以某价格**卖出** YES 代币

做市商的存在让其他交易者能立刻找到对手方，不用等待。这就是"提供流动性"。

### 1.2 三条盈利来源

```
盈利来源                 占比（典型）    风险等级    说明
─────────────────────────────────────────────────────────────
LP 奖励（Q-Score）         60–70%         低          平台按挂单质量分配每日奖励池
做市价差（Spread）         20–30%         中          买低卖高赚取差价
方向性持仓                  5–15%         高          对事件结果的方向性押注
─────────────────────────────────────────────────────────────
```

**关键认知：LP 奖励是支柱**。价差收益依赖市场成交量，方向性收益本质是赌博。
只有奖励是"只要合规挂单就能拿到"的相对稳定收入。

### 1.3 为什么 Polymarket 是 CLOB 而不是 AMM

Polymarket 使用 **中央限价订单簿（CLOB）**，不是 AMM（如 Uniswap）：

| 维度 | CLOB（Polymarket） | AMM（Uniswap） |
|------|--------------------|----------------|
| 报价方式 | 做市商主动挂单 | 公式自动定价 |
| 价格控制 | 做市商决定 | 算法决定 |
| 滑点 | 取决于订单簿深度 | 取决于流动性池大小 |
| Gas 消耗 | 链下撮合 + 链上结算 | 每笔交易都上链 |
| 做市收益 | 价差 + 平台奖励 | 手续费分成 |

CLOB 的核心优势：做市商可以精确控制价格，策略更灵活。

---

## 2. Polymarket 的特殊性：预测市场做市

### 2.1 YES 和 NO 代币的关系

每个预测市场有两种代币：YES 和 NO。**P(YES) + P(NO) = 1** 是必然等式。

```
举例：某市场"拜登2024年赢得大选"
  如果 YES 当前价格 = 0.40（40% 概率）
  那么 NO 当前价格 = 0.60（60% 概率）

关键等价关系：
  买入 YES @ 0.40  ≡  卖出 NO @ 0.60（完全相同！）

Polymarket 只维护一个订单簿（YES 代币的订单簿），
系统自动将 YES 订单映射到 NO 侧。
做市商只需操作 YES 代币。
```

### 2.2 有限生命周期：市场会"结算"

普通金融市场是永续的，预测市场有结算时间点：
- 结算时，YES 结果 → 每股 YES = $1，每股 NO = $0
- 结算时，NO 结果 → 每股 YES = $0，每股 NO = $1

**对做市策略的影响：**
- 越接近结算，价格波动越极端（趋向 0 或 1）
- 结算前 24h 必须大幅拉宽价差
- 结算前 2h 必须完全退出该市场

### 2.3 事件驱动的价格跳跃

普通金融市场价格是连续变动的，预测市场存在**非连续跳跃**：
- 一条新闻可以让价格在 5 秒内从 0.50 跳到 0.90
- 这比做市商来得及反应要快
- 知情交易者（掌握内幕的人）会在这 5 秒内扫光你的挂单

→ 事件检测和快速撤单是核心风险防御手段。

---

## 3. 系统模块划分

```
┌─────────────────────────────────────────────────────────┐
│                    监控 / 告警层                          │
│  PnL 实时追踪  │  奖励统计  │  异常告警  │  日志记录     │
├─────────────────────────────────────────────────────────┤
│                    策略层（核心大脑）                      │
│  市场筛选器  │  定价引擎  │  持仓管理器  │  风控模块      │
├─────────────────────────────────────────────────────────┤
│                    执行层                                │
│  订单管理器  │  批量处理器  │  Merge 处理器  │  重试机制  │
├─────────────────────────────────────────────────────────┤
│                    数据层                                │
│  CLOB Client  │  WebSocket 流  │  Gamma API  │  外部信号 │
└─────────────────────────────────────────────────────────┘
```

各模块详细说明见对应文档：

| 文档 | 内容 |
|------|------|
| [01-data-layer.md](./01-data-layer.md) | 数据层：WebSocket、REST API、数据模型 |
| [02-qscore-rewards.md](./02-qscore-rewards.md) | Q-Score 与奖励机制（完整数学推导） |
| [03-pricing-engine.md](./03-pricing-engine.md) | 定价引擎：价差计算、阶梯挂单 |
| [04-position-management.md](./04-position-management.md) | 持仓管理：IIR、Quote Skewing、Merge |
| [05-risk-control.md](./05-risk-control.md) | 三级风控体系：L1/L2/L3 状态机 |
| [06-execution-layer.md](./06-execution-layer.md) | 执行层：订单生命周期、链上操作 |

---

## 4. 系统数据流（完整）

```
┌─────────────────────────────────────────────────────────────────────┐
│                           外部数据源                                  │
│                                                                       │
│  Polymarket CLOB WebSocket          Gamma REST API                   │
│  ├─ market channel（公开）           ├─ 市场列表                       │
│  │   ├─ book（订单簿快照）            ├─ 奖励配置                       │
│  │   ├─ price_change                └─ 市场元数据                      │
│  │   └─ trade（成交）                                                  │
│  └─ user channel（私有，需认证）                                        │
│      └─ order_update（我的订单状态）                                    │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────────┐
│                          数据层（Data Layer）                          │
│                                                                       │
│  实时状态缓存（内存）：                                                  │
│    market_states: { market_id → { midpoint, spread, orderbook } }   │
│    my_orders:     { order_id  → { price, size, side, status } }     │
│    positions:     { market_id → { yes_shares, no_shares } }         │
│                                                                       │
│  历史数据存储（SQLite/PostgreSQL）：                                     │
│    price_history, trade_history, pnl_records, reward_records        │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
┌─────────────┐   ┌─────────────┐   ┌──────────────┐
│  市场筛选器  │   │  定价引擎   │   │  持仓管理器   │
│             │   │             │   │              │
│ 每5分钟扫描 │   │ 每10秒触发  │   │  每分钟检查  │
│ 所有市场    │   │ 计算最优价差 │   │  IIR 失衡度  │
│ 输出目标    │   │ 生成阶梯挂单 │   │  决定调仓    │
│ 市场列表    │   │             │   │  触发 Merge  │
└──────┬──────┘   └──────┬──────┘   └──────┬───────┘
       │                 │                  │
       └─────────────────┼──────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         风控模块（Risk Controller）                     │
│                                                                       │
│  持续监控所有指标，根据风险等级决定是否允许执行：                            │
│    L1（正常）→ 允许全部操作                                              │
│    L2（预警）→ 允许操作但限制规模                                         │
│    L3（紧急）→ 阻止所有新操作，执行紧急撤单                               │
└──────────────────────────────┬───────────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         执行层（Execution Layer）                       │
│                                                                       │
│  OrderManager: 管理订单创建、取消、状态追踪                               │
│  BatchProcessor: 批量提交（最多15个/批），管理 API 限流                    │
│  MergeHandler: 触发链上 CTF 合约的 mergePositions 操作                   │
│  RetryHandler: 失败时指数退避重试                                         │
└──────────────────────────────┬───────────────────────────────────────┘
                               │
                               ▼
               Polymarket CLOB API（链下撮合）
               Polygon 链上合约（Merge / Redeem）
```

---

## 5. 系统启动顺序

各模块有依赖关系，必须按顺序启动：

```
Step 1: 加载配置
  读取 .env：私钥、API Key、风控阈值、目标市场列表

Step 2: 初始化存储
  创建/连接数据库
  建立内存状态缓存（market_states, positions, my_orders）

Step 3: 验证 API 连接
  发送一个 GET /balance 请求，验证 API Key 和私钥有效

Step 4: 建立 WebSocket 连接（两个）
  market channel：订阅所有目标市场的实时数据
  user channel：订阅我的订单更新

Step 5: 拉取初始状态
  GET /markets（Gamma API）→ 更新市场元数据
  GET /positions（CLOB API）→ 恢复当前持仓
  对比数据库记录，检查是否有未记录的持仓

Step 6: 启动风控模块
  初始化风控状态为 L1
  注册所有风控检查规则
  ★ 先启动风控，再启动策略引擎

Step 7: 启动策略引擎
  运行市场筛选器，确定目标市场
  为每个目标市场生成初始挂单

Step 8: 启动监控告警
  连接 Telegram Bot
  启动 PnL 追踪定时器
  启动奖励追踪定时器
```

---

## 6. 关键技术约束

| 约束 | 数值 | 影响 |
|------|------|------|
| 批量下单上限 | 15 个/批 | 多市场同时更新时需要分批 |
| API 限流 | 3000 次/10分钟 | 不能过于频繁地更新挂单 |
| WebSocket 保活 | 每 10 秒 PING | 断线会导致错过价格变动 |
| 最小 Merge 规模 | 建议 $100 | 低于此值 Gas 成本超过收益 |
| Q-Score 采样频率 | 每分钟 1 次 | 每周 10,080 次快照 |
| 奖励结算周期 | 每日 UTC 00:00 | 当天的挂单次日才能确认奖励 |
| 市场价格范围 | [0.01, 0.99] | 不能挂 0 或 1 的价格 |

---

## 7. 需要在开发前确认的参数

以下参数影响整个系统的设计，需要先确定：

```
资金规模（影响仓位限额设计）：
  建议：$5,000 ~ $50,000 范围内
  单市场最大仓位 = 总资金 × 20%

目标市场数量：
  MVP：1 ~ 3 个市场（手动管理）
  半自动：3 ~ 6 个市场
  全自动：6 ~ 12 个市场

运行模式：
  模式1：只看不动（数据监控工具）
  模式2：半自动（自动计算，手动确认执行）
  模式3：全自动（策略引擎自动执行）

风险偏好：
  保守：价差宽、仓位小、奖励为主
  激进：价差窄、仓位大、追求高 Q-Score
```
